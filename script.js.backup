// æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
function checkAuth() {
    const token = localStorage.getItem('authToken');
    if (!token) {
        // å¦‚æœæ²¡æœ‰ä»¤ç‰Œï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
        window.location.href = '/login';
        return false;
    }
    
    // éªŒè¯ä»¤ç‰Œæ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼ˆå¯é€‰ï¼‰
    // è¿™é‡Œå¯ä»¥å‘èµ·ä¸€ä¸ªè½»é‡çº§APIè¯·æ±‚éªŒè¯ä»¤ç‰Œ
    return true;
}

// è·å–å½“å‰ç”¨æˆ·å
async function getCurrentUser() {
    const token = localStorage.getItem('authToken');
    if (!token) {
        return null;
    }
    
    try {
        // è§£ç JWTä»¤ç‰Œè·å–ç”¨æˆ·ä¿¡æ¯
        const tokenPayload = JSON.parse(atob(token.split('.')[1]));
        return tokenPayload.username;
    } catch (error) {
        console.error('Error decoding token:', error);
        return null;
    }
}

// ç™»å‡ºåŠŸèƒ½
function logout() {
    localStorage.removeItem('authToken');
    window.location.href = '/login';
}

// æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œç™»å‡ºé€‰é¡¹
function showUserInfo() {
    getCurrentUser().then(username => {
        if (username) {
            // æ›´æ–°ç”¨æˆ·åæ˜¾ç¤º
            const usernameDisplay = document.getElementById('usernameDisplay');
            if (usernameDisplay) {
                usernameDisplay.textContent = username;
            }
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå°šæœªæ·»åŠ ï¼‰
            if (!window.settingsInitialized) {
                document.getElementById('settingsButton').addEventListener('click', toggleSettingsDropdown);
                document.getElementById('logoutBtn').addEventListener('click', logout);
                document.getElementById('userSettingsBtn').addEventListener('click', () => {
                    window.location.href = '/settings';
                });
                
                // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸéšè—ä¸‹æ‹‰èœå•
                document.addEventListener('click', function(event) {
                    const dropdown = document.getElementById('settingsDropdown');
                    const button = document.getElementById('settingsButton');
                    
                    if (button && dropdown && !button.contains(event.target) && !dropdown.contains(event.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
                
                window.settingsInitialized = true;
            }
        }
    });
}

// åˆ‡æ¢è®¾ç½®ä¸‹æ‹‰èœå•
function toggleSettingsDropdown() {
    const dropdown = document.getElementById('settingsDropdown');
    if (dropdown.classList.contains('visible')) {
        // éšè—ä¸‹æ‹‰èœå•
        dropdown.classList.remove('visible');
        setTimeout(() => {
            dropdown.classList.add('hidden');
        }, 300); // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†éšè—
    } else {
        // æ˜¾ç¤ºä¸‹æ‹‰èœå•
        dropdown.classList.remove('hidden');
        // å¼ºåˆ¶é‡æ’ä»¥ç¡®ä¿hiddenç±»è¢«ç§»é™¤åå†æ·»åŠ visibleç±»
        dropdown.offsetHeight;
        dropdown.classList.add('visible');
    }
}

// åº”ç”¨ç”¨æˆ·è®¾ç½®
function applyUserSettings() {
    const savedLanguage = localStorage.getItem('language') || 'zh-CN';
    const savedTitle = localStorage.getItem('customTitle') || 'ä»“åº“ç®¡ç†ç³»ç»Ÿ';
    
    // æ›´æ–°é¡µé¢æ ‡é¢˜
    document.querySelector('header h1').innerHTML = 'ğŸ“¦ ' + savedTitle;
    
    // æ ¹æ®è¯­è¨€è®¾ç½®æ›´æ–°å…¶ä»–æ–‡æœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (savedLanguage === 'en-US') {
        // è‹±æ–‡è®¾ç½®
        const inventoryContainers = document.querySelectorAll('.inventory-container h2');
        inventoryContainers.forEach(element => {
            element.textContent = 'Inventory List';
        });
        
        const statCards = document.querySelectorAll('.stat-card h3');
        statCards[0].textContent = 'Total Items';
        statCards[1].textContent = 'Total Quantity';
        
        const actionButtons = document.querySelector('#toggleButtonsBtn');
        if (actionButtons) {
            actionButtons.textContent = 'Actions';
        }
        
        const searchInput = document.querySelector('#searchInput');
        if (searchInput) {
            searchInput.placeholder = 'Search items...';
        }
        
        const itemLabels = document.querySelectorAll('.input-group label');
        if (itemLabels.length >= 3) {
            itemLabels[0].textContent = 'Item Name:';
            itemLabels[1].textContent = 'Quantity:';
            itemLabels[2].textContent = 'Low Stock Alert:';
        }
        
        // æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
        const itemNameInput = document.querySelector('#itemName');
        if (itemNameInput) {
            itemNameInput.placeholder = 'Enter item name';
        }
        
        const itemQuantityInput = document.querySelector('#itemQuantity');
        if (itemQuantityInput) {
            itemQuantityInput.placeholder = 'Enter quantity';
        }
        
        const itemThresholdInput = document.querySelector('#itemThreshold');
        if (itemThresholdInput) {
            itemThresholdInput.placeholder = 'Enter minimum stock';
        }
        
        const addItemBtn = document.querySelector('#addItemBtn');
        if (addItemBtn) {
            addItemBtn.textContent = 'Add Item';
        }
        
        const emptyState = document.querySelector('.empty-state p:first-child');
        if (emptyState) {
            emptyState.textContent = 'No inventory data';
        }
        
        // æ›´æ–°æ“ä½œæŒ‰é’®æç¤ºæ–‡æœ¬å’Œå†…å®¹
        const exportBtn = document.querySelector('#exportDataBtn');
        if (exportBtn) {
            exportBtn.title = 'Export Data';
            exportBtn.textContent = 'Export';
        }
        
        const importBtn = document.querySelector('#importDataBtn');
        if (importBtn) {
            importBtn.title = 'Import Data';
            importBtn.textContent = 'Import';
        }
        
        const selectAllBtn = document.querySelector('#selectAllBtn');
        if (selectAllBtn) {
            selectAllBtn.title = 'Select All';
            selectAllBtn.textContent = 'Select All';
        }
        
        const batchDeleteBtn = document.querySelector('#batchDeleteBtn');
        if (batchDeleteBtn) {
            batchDeleteBtn.title = 'Batch Delete';
            batchDeleteBtn.textContent = 'Delete';
        }
        
        // æ›´æ–°åº“å­˜é¡¹ç›®çš„è¯­è¨€æ–‡æœ¬
        updateInventoryItemTexts('en-US');
    } else {
        // ä¸­æ–‡è®¾ç½®ï¼ˆé»˜è®¤ï¼‰
        const inventoryContainers = document.querySelectorAll('.inventory-container h2');
        inventoryContainers.forEach(element => {
            element.textContent = 'åº“å­˜æ¸…å•';
        });
        
        const statCards = document.querySelectorAll('.stat-card h3');
        statCards[0].textContent = 'æ€»è´§ç‰©ç§ç±»';
        statCards[1].textContent = 'æ€»æ•°é‡';
        
        const actionButtons = document.querySelector('#toggleButtonsBtn');
        if (actionButtons) {
            actionButtons.textContent = 'æ“ä½œ';
        }
        
        const searchInput = document.querySelector('#searchInput');
        if (searchInput) {
            searchInput.placeholder = 'æœç´¢è´§ç‰©...';
        }
        
        const itemLabels = document.querySelectorAll('.input-group label');
        if (itemLabels.length >= 3) {
            itemLabels[0].textContent = 'è´§ç‰©åç§°:';
            itemLabels[1].textContent = 'è´§ç‰©æ•°é‡:';
            itemLabels[2].textContent = 'æœ€ä½åº“å­˜æé†’:';
        }
        
        // æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
        const itemNameInput = document.querySelector('#itemName');
        if (itemNameInput) {
            itemNameInput.placeholder = 'è¾“å…¥è´§ç‰©åç§°';
        }
        
        const itemQuantityInput = document.querySelector('#itemQuantity');
        if (itemQuantityInput) {
            itemQuantityInput.placeholder = 'è¾“å…¥æ•°é‡';
        }
        
        const itemThresholdInput = document.querySelector('#itemThreshold');
        if (itemThresholdInput) {
            itemThresholdInput.placeholder = 'è¾“å…¥æœ€ä½åº“å­˜';
        }
        
        const addItemBtn = document.querySelector('#addItemBtn');
        if (addItemBtn) {
            addItemBtn.textContent = 'æ·»åŠ è´§ç‰©';
        }
        
        const emptyState = document.querySelector('.empty-state p:first-child');
        if (emptyState) {
            emptyState.textContent = 'æš‚æ— åº“å­˜æ•°æ®';
        }
        
        // æ›´æ–°æ“ä½œæŒ‰é’®æç¤ºæ–‡æœ¬å’Œå†…å®¹
        const exportBtn = document.querySelector('#exportDataBtn');
        if (exportBtn) {
            exportBtn.title = 'å¯¼å‡ºæ•°æ®';
            exportBtn.textContent = 'å¯¼å‡º';
        }
        
        const importBtn = document.querySelector('#importDataBtn');
        if (importBtn) {
            importBtn.title = 'å¯¼å…¥æ•°æ®';
            importBtn.textContent = 'å¯¼å…¥';
        }
        
        const selectAllBtn = document.querySelector('#selectAllBtn');
        if (selectAllBtn) {
            selectAllBtn.title = 'å…¨é€‰';
            selectAllBtn.textContent = 'å…¨é€‰';
        }
        
        const batchDeleteBtn = document.querySelector('#batchDeleteBtn');
        if (batchDeleteBtn) {
            batchDeleteBtn.title = 'æ‰¹é‡åˆ é™¤';
            batchDeleteBtn.textContent = 'åˆ é™¤';
        }
        
        // æ›´æ–°åº“å­˜é¡¹ç›®çš„è¯­è¨€æ–‡æœ¬
        updateInventoryItemTexts('zh-CN');
    }
}

// æ›´æ–°åº“å­˜é¡¹ç›®ä¸­æ–‡æœ¬
function updateInventoryItemTexts(language) {
    // æ›´æ–°æ‰€æœ‰åº“å­˜é¡¹ç›®çš„åˆ é™¤æŒ‰é’®æ–‡æœ¬
    const deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach(button => {
        if (language === 'en-US') {
            button.textContent = 'Delete';
        } else {
            button.textContent = 'åˆ é™¤';
        }
    });
    
    // æ›´æ–°ä½åº“å­˜æé†’æ ‡è¯†
    const lowStockItems = document.querySelectorAll('.inventory-item.low-stock .item-name');
    lowStockItems.forEach(element => {
        // å¦‚æœæ˜¯ä½åº“å­˜é¡¹ç›®ï¼Œç¡®ä¿å…¶è­¦å‘Šæ ‡è¯†æ­£ç¡®æ˜¾ç¤º
        if (language === 'en-US') {
            // å¯¹äºè‹±æ–‡ç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ é¢å¤–çš„è­¦å‘Šæ ‡è¯†
        } else {
            // ä¸­æ–‡ç¯å¢ƒ
        }
    });
}

// åœ¨DOMåŠ è½½å®Œæˆåæ£€æŸ¥èº«ä»½éªŒè¯
document.addEventListener('DOMContentLoaded', () => {
    if (!checkAuth()) {
        return; // å¦‚æœæœªè®¤è¯ï¼Œåˆ™ä¸åˆå§‹åŒ–WarehouseManager
    }
    
    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    showUserInfo();
    
    // åº”ç”¨ç”¨æˆ·è®¾ç½®
    applyUserSettings();
});

// ä»“åº“ç®¡ç†ç³»ç»Ÿ JavaScript é€»è¾‘
class WarehouseManager {
    constructor() {
        this.items = [];
        this.nextId = 1;
        this.lowStockThreshold = 5; // é»˜è®¤ä½åº“å­˜é˜ˆå€¼
        this.selectedItems = new Set(); // ç”¨äºæ‰¹é‡æ“ä½œ
        this.expandedChartId = null; // å½“å‰å±•å¼€çš„å›¾è¡¨ID
        this.chartHistory = {}; // å­˜å‚¨æ¯ä¸ªç‰©å“çš„å†å²æ•°æ®
        this.init();
    }

    init() {
        this.loadFromStorage();
        this.initializeChartHistory();
        this.bindEvents();
        this.render();
    }

    initializeChartHistory() {
        // åˆå§‹åŒ–å›¾è¡¨å†å²æ•°æ®ï¼Œæ¯ä¸ªç‰©å“éƒ½æœ‰ä¸€ä¸ªå†å²è®°å½•æ•°ç»„
        for (const item of this.items) {
            if (!this.chartHistory[item.id]) {
                // åˆå§‹åŒ–å†å²è®°å½•ï¼ŒåŒ…å«å½“å‰æ•°é‡å’Œè¿‡å»å‡ å¤©çš„æ•°æ®
                this.chartHistory[item.id] = [
                    { date: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], quantity: Math.max(1, item.quantity - 3) },
                    { date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], quantity: Math.max(1, item.quantity - 2) },
                    { date: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], quantity: Math.max(1, item.quantity - 1) },
                    { date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], quantity: item.quantity },
                    { date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], quantity: item.quantity },
                    { date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], quantity: item.quantity },
                    { date: new Date().toISOString().split('T')[0], quantity: item.quantity }
                ];
            }
        }
    }

    async loadFromStorage() {
        try {
            // é¦–å…ˆå°è¯•ä»æœåŠ¡å™¨åŠ è½½æ•°æ®
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/inventory', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                const data = await response.json();
                this.items = data.items || [];
                this.nextId = data.nextId || 1;
            } else {
                // å¦‚æœæœåŠ¡å™¨ä¸å¯ç”¨ï¼Œåˆ™ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                const savedData = localStorage.getItem('warehouseData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    this.items = parsed.items || [];
                    this.nextId = parsed.nextId || 1;
                } else {
                    // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
                    this.items = [
                        { id: 1, name: "ç¬”è®°æœ¬ç”µè„‘", quantity: 10, threshold: 5 },
                        { id: 2, name: "é¼ æ ‡", quantity: 50, threshold: 10 },
                        { id: 3, name: "é”®ç›˜", quantity: 30, threshold: 8 },
                        { id: 4, name: "æ˜¾ç¤ºå™¨", quantity: 15, threshold: 3 },
                        { id: 5, name: "éŸ³å“", quantity: 8, threshold: 2 }
                    ];
                    this.nextId = 6;
                    this.saveToStorage();
                }
            }
        } catch (error) {
            // å¦‚æœæœåŠ¡å™¨è¯·æ±‚å¤±è´¥ï¼Œä»æœ¬åœ°å­˜å‚¨åŠ è½½
            const savedData = localStorage.getItem('warehouseData');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                this.items = parsed.items || [];
                this.nextId = parsed.nextId || 1;
            } else {
                // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
                this.items = [
                    { id: 1, name: "ç¬”è®°æœ¬ç”µè„‘", quantity: 10, threshold: 5 },
                    { id: 2, name: "é¼ æ ‡", quantity: 50, threshold: 10 },
                    { id: 3, name: "é”®ç›˜", quantity: 30, threshold: 8 },
                    { id: 4, name: "æ˜¾ç¤ºå™¨", quantity: 15, threshold: 3 },
                    { id: 5, name: "éŸ³å“", quantity: 8, threshold: 2 }
                ];
                this.nextId = 6;
                this.saveToStorage();
            }
        }
        this.initializeChartHistory();
        this.render();
    }

    async saveToStorage() {
        // å°è¯•ä¿å­˜åˆ°æœåŠ¡å™¨
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/inventory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    items: this.items,
                    nextId: this.nextId,
                    chartHistory: this.chartHistory
                })
            });
            
            if (!response.ok) {
                // å¦‚æœæœåŠ¡å™¨ä¿å­˜å¤±è´¥ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const data = {
                    items: this.items,
                    nextId: this.nextId,
                    chartHistory: this.chartHistory
                };
                localStorage.setItem('warehouseData', JSON.stringify(data));
            }
        } catch (error) {
            // å¦‚æœæœåŠ¡å™¨ä¿å­˜å¤±è´¥ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const data = {
                items: this.items,
                nextId: this.nextId,
                chartHistory: this.chartHistory
            };
            localStorage.setItem('warehouseData', JSON.stringify(data));
        }
    }

    async addItem(name, quantity, threshold = 5) {
        if (!name.trim()) return false;
        
        try {
            // å…ˆå°è¯•ä¿å­˜åˆ°æœåŠ¡å™¨
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/inventory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name: name.trim(),
                    quantity: parseInt(quantity) || 0,
                    threshold: parseInt(threshold) || 5
                })
            });
            
            if (!response.ok) {
                alert('æ·»åŠ ç‰©å“å¤±è´¥ï¼Œè¯·é‡è¯•');
                return false;
            }
            
            const savedItem = await response.json();
            
            // æœåŠ¡å™¨ä¿å­˜æˆåŠŸåï¼Œæ›´æ–°æœ¬åœ°æ•°æ®
            this.items.push(savedItem);
            this.nextId = Math.max(this.nextId, savedItem.id + 1); // ç¡®ä¿nextIdæ­£ç¡®
            
            // ä¸ºæ–°é¡¹ç›®åˆå§‹åŒ–å›¾è¡¨å†å²
            this.chartHistory[savedItem.id] = [
                { date: new Date().toISOString().split('T')[0], quantity: savedItem.quantity }
            ];
            
        } catch (error) {
            alert('ç½‘ç»œé”™è¯¯ï¼Œæ·»åŠ ç‰©å“å¤±è´¥');
            console.error('Add item error:', error);
            return false;
        }
        
        this.render();
        return true;
    }

    async updateQuantity(id, newQuantity) {
        const item = this.items.find(item => item.id === id);
        if (item) {
            const oldQuantity = item.quantity;
            const newQty = Math.max(0, parseInt(newQuantity) || 0);
            
            // å…ˆå°è¯•æ›´æ–°æœåŠ¡å™¨
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/inventory/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        quantity: newQty
                    })
                });
                
                if (!response.ok) {
                    alert('æ›´æ–°æ•°é‡å¤±è´¥ï¼Œè¯·é‡è¯•');
                    return;
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œæ›´æ–°æ•°é‡å¤±è´¥');
                console.error('Update quantity error:', error);
                return;
            }
            
            // æœåŠ¡å™¨æ›´æ–°æˆåŠŸåï¼Œæ›´æ–°æœ¬åœ°æ•°æ®
            item.quantity = newQty;
            
            // æ›´æ–°å›¾è¡¨å†å²è®°å½•
            const today = new Date().toISOString().split('T')[0];
            if (!this.chartHistory[id]) {
                this.chartHistory[id] = [];
            }
            
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æœ‰è®°å½•
            const todayRecordIndex = this.chartHistory[id].findIndex(record => record.date === today);
            if (todayRecordIndex !== -1) {
                this.chartHistory[id][todayRecordIndex].quantity = item.quantity;
            } else {
                // æ·»åŠ ä»Šå¤©çš„è®°å½•
                this.chartHistory[id].push({ date: today, quantity: item.quantity });
                // åªä¿ç•™æœ€è¿‘7å¤©çš„æ•°æ®
                this.chartHistory[id] = this.chartHistory[id].slice(-7);
            }
            
            this.render();
        }
    }

    async deleteItem(id) {
        // æ‰¾åˆ°è¦åˆ é™¤çš„é¡¹ç›®å…ƒç´ 
        const itemElement = document.querySelector(`.inventory-item[data-id="${id}"]`);
        
        // å…ˆå°è¯•ä»æœåŠ¡å™¨åˆ é™¤
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch(`/api/inventory/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                // æœåŠ¡å™¨åˆ é™¤å¤±è´¥ï¼Œæç¤ºç”¨æˆ·
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                return;
            }
        } catch (error) {
            // æœåŠ¡å™¨åˆ é™¤å¤±è´¥ï¼Œæç¤ºç”¨æˆ·
            alert('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥');
            console.error('Delete error:', error);
            return;
        }
        
        // æœåŠ¡å™¨åˆ é™¤æˆåŠŸåï¼Œä»æœ¬åœ°ç§»é™¤é¡¹ç›®å¹¶æ‰§è¡ŒåŠ¨ç”»
        if (itemElement) {
            // æ·»åŠ åˆ é™¤åŠ¨ç”»
            itemElement.style.transition = 'all 0.3s ease';
            itemElement.style.opacity = '0';
            itemElement.style.transform = 'translateX(-100%)';
            itemElement.style.height = '0';
            itemElement.style.padding = '0';
            itemElement.style.margin = '0';
            itemElement.style.overflow = 'hidden';
            
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåä»æœ¬åœ°ç§»é™¤
            setTimeout(() => {
                this.items = this.items.filter(item => item.id !== id);
                
                // åˆ é™¤å¯¹åº”çš„å›¾è¡¨å†å²
                if (this.chartHistory[id]) {
                    delete this.chartHistory[id];
                }
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å±•å¼€å›¾è¡¨çš„é¡¹ç›®ï¼Œæ”¶èµ·å›¾è¡¨
                if (this.expandedChartId === id) {
                    this.expandedChartId = null;
                }
                
                this.render();
            }, 300);
        } else {
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å…ƒç´ ï¼ˆæ¯”å¦‚åœ¨æœç´¢è§†å›¾ä¸­ï¼‰ï¼Œç›´æ¥ä»æœ¬åœ°ç§»é™¤
            this.items = this.items.filter(item => item.id !== id);
            
            // åˆ é™¤å¯¹åº”çš„å›¾è¡¨å†å²
            if (this.chartHistory[id]) {
                delete this.chartHistory[id];
            }
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å±•å¼€å›¾è¡¨çš„é¡¹ç›®ï¼Œæ”¶èµ·å›¾è¡¨
            if (this.expandedChartId === id) {
                this.expandedChartId = null;
            }
            
            this.render();
        }
    }

    // å…¨é€‰åŠŸèƒ½
    selectAllItems(selectAll = true) {
        // è·å–å½“å‰æ˜¾ç¤ºçš„é¡¹ç›®ï¼ˆè€ƒè™‘æœç´¢è¿‡æ»¤ï¼‰
        const searchQuery = document.getElementById('searchInput').value;
        let displayedItems;
        if (!searchQuery) {
            displayedItems = this.items;
        } else {
            displayedItems = this.items.filter(item => 
                item.name.toLowerCase().includes(searchQuery.toLowerCase())
            );
        }

        if (selectAll) {
            // é€‰ä¸­æ‰€æœ‰æ˜¾ç¤ºçš„é¡¹ç›®
            displayedItems.forEach(item => {
                this.selectedItems.add(item.id);
            });
        } else {
            // å–æ¶ˆé€‰ä¸­æ‰€æœ‰æ˜¾ç¤ºçš„é¡¹ç›®
            displayedItems.forEach(item => {
                this.selectedItems.delete(item.id);
            });
        }

        this.render();
    }

    // æ‰¹é‡åˆ é™¤é€‰ä¸­çš„é¡¹ç›®
    async deleteSelectedItems() {
        if (this.selectedItems.size === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${this.selectedItems.size} ä¸ªé¡¹ç›®å—ï¼Ÿ`)) {
            return;
        }

        // å…ˆå°è¯•ä»æœåŠ¡å™¨åˆ é™¤é€‰ä¸­çš„é¡¹ç›®
        const selectedIds = Array.from(this.selectedItems);
        let allSuccessful = true;

        for (const id of selectedIds) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/inventory/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    console.error(`Failed to delete item ${id}:`, response.statusText);
                    allSuccessful = false;
                }
            } catch (error) {
                console.error(`Error deleting item ${id}:`, error);
                allSuccessful = false;
            }
        }

        if (!allSuccessful) {
            alert('éƒ¨åˆ†é¡¹ç›®åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            return;
        }

        // æœåŠ¡å™¨åˆ é™¤æˆåŠŸåï¼Œä»æœ¬åœ°ç§»é™¤é¡¹ç›®
        for (const id of selectedIds) {
            this.items = this.items.filter(item => item.id !== id);
            
            // åˆ é™¤å¯¹åº”çš„å›¾è¡¨å†å²
            if (this.chartHistory[id]) {
                delete this.chartHistory[id];
            }
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å±•å¼€å›¾è¡¨çš„é¡¹ç›®ï¼Œæ”¶èµ·å›¾è¡¨
            if (this.expandedChartId === id) {
                this.expandedChartId = null;
            }
        }

        // æ¸…ç©ºé€‰ä¸­é¡¹
        this.selectedItems.clear();

        this.render();
    }

    // åˆ‡æ¢å›¾è¡¨æ˜¾ç¤º
    toggleChart(itemId) {
        if (this.expandedChartId === itemId) {
            // å¦‚æœå½“å‰å±•å¼€çš„å°±æ˜¯è¿™ä¸ªå›¾è¡¨ï¼Œåˆ™æ”¶èµ·
            this.expandedChartId = null;
        } else {
            // å¦åˆ™å±•å¼€è¿™ä¸ªå›¾è¡¨
            this.expandedChartId = itemId;
        }
        this.render();
    }

    // ç»˜åˆ¶å›¾è¡¨
    drawChart(canvasId, itemId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const history = this.chartHistory[itemId] || [];
        
        if (history.length === 0) return;
        
        // è®¾ç½®ç”»å¸ƒå¤§å°
        canvas.width = canvas.offsetWidth * 2;
        canvas.height = canvas.offsetHeight * 2;
        ctx.scale(2, 2); // é«˜åˆ†è¾¨ç‡
        
        // è·å–æœ€å¤§å€¼å’Œæœ€å°å€¼ä»¥ç¡®å®šèŒƒå›´
        const quantities = history.map(item => item.quantity);
        const maxQty = Math.max(...quantities);
        const minQty = Math.min(...quantities);
        const range = maxQty - minQty || 1; // é˜²æ­¢èŒƒå›´ä¸º0
        
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;
        const padding = 30;
        const chartWidth = width - 2 * padding;
        const chartHeight = height - 2 * padding;
        
        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, width, height);
        
        // ç»˜åˆ¶ç½‘æ ¼çº¿
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;
        
        // æ°´å¹³ç½‘æ ¼çº¿
        for (let i = 0; i <= 5; i++) {
            const y = padding + (chartHeight / 5) * i;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();
            
            // æ·»åŠ æ•°å€¼æ ‡ç­¾
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';
            const value = Math.round(maxQty - (range / 5) * i);
            ctx.fillText(value.toString(), padding - 5, y + 4);
        }
        
        // å‚ç›´ç½‘æ ¼çº¿å’Œæ—¥æœŸæ ‡ç­¾
        for (let i = 0; i < history.length; i++) {
            const x = padding + (chartWidth / (history.length - 1)) * i;
            ctx.beginPath();
            ctx.moveTo(x, padding);
            ctx.lineTo(x, height - padding);
            ctx.stroke();
            
            // æ·»åŠ æ—¥æœŸæ ‡ç­¾
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const date = history[i].date.split('-')[2]; // åªæ˜¾ç¤ºæ—¥
            ctx.fillText(date, x, height - 5);
        }
        
        // ç»˜åˆ¶æŠ˜çº¿
        ctx.beginPath();
        for (let i = 0; i < history.length; i++) {
            const x = padding + (chartWidth / (history.length - 1)) * i;
            const y = padding + chartHeight - ((history[i].quantity - minQty) / range) * chartHeight;
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.strokeStyle = '#667eea';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // ç»˜åˆ¶æ•°æ®ç‚¹
        for (let i = 0; i < history.length; i++) {
            const x = padding + (chartWidth / (history.length - 1)) * i;
            const y = padding + chartHeight - ((history[i].quantity - minQty) / range) * chartHeight;
            
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fillStyle = '#667eea';
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        // æ·»åŠ æ ‡é¢˜
        const item = this.items.find(item => item.id === itemId);
        if (item) {
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${item.name} æ•°é‡è¶‹åŠ¿`, width / 2, 15);
        }
    }

    // å¯¼å‡ºæ•°æ®
    async exportData() {
        try {
            // ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®ï¼Œç¡®ä¿å¯¼å‡ºçš„æ˜¯æœ€æ–°çš„æ•°æ®
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/inventory', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const dataStr = JSON.stringify({
                    items: data.items || [],
                    nextId: data.nextId || 1,
                    chartHistory: this.chartHistory
                }, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `warehouse-backup-${new Date().toISOString().slice(0, 19)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            } else {
                // å¦‚æœæœåŠ¡å™¨è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®å¯¼å‡º
                const dataStr = JSON.stringify({
                    items: this.items,
                    nextId: this.nextId,
                    chartHistory: this.chartHistory
                }, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `warehouse-backup-${new Date().toISOString().slice(0, 19)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }
        } catch (error) {
            // å¦‚æœæœåŠ¡å™¨è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®å¯¼å‡º
            const dataStr = JSON.stringify({
                items: this.items,
                nextId: this.nextId,
                chartHistory: this.chartHistory
            }, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `warehouse-backup-${new Date().toISOString().slice(0, 19)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
    }

    // å¯¼å…¥æ•°æ®
    async importData(file) {
        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                
                if (importedData.items && Array.isArray(importedData.items)) {
                    // å‘é€å¯¼å…¥è¯·æ±‚åˆ°æœåŠ¡å™¨
                    const token = localStorage.getItem('authToken');
                    const response = await fetch('/api/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(importedData.items)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        // é‡æ–°ä»æœåŠ¡å™¨åŠ è½½æ•°æ®ä»¥ç¡®ä¿åŒæ­¥
                        await this.loadFromStorage();
                        this.render();
                        alert(result.message || 'æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    } else {
                        const errorResult = await response.json();
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + errorResult.error);
                    }
                } else {
                    alert('å¯¼å…¥çš„æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
                }
            } catch (error) {
                alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–æŸåï¼');
                console.error('Import error:', error);
            }
        };
        reader.onerror = () => {
            alert('å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è¯»å–æ–‡ä»¶ï¼');
        };
        reader.readAsText(file);
    }

    // æ£€æŸ¥ä½åº“å­˜
    isLowStock(item) {
        return item.quantity <= (item.threshold || this.lowStockThreshold);
    }

    async searchItems(query) {
        if (!query) return this.items;
        
        try {
            // ä½¿ç”¨æœåŠ¡å™¨ç«¯çš„å¢å¼ºæœç´¢åŠŸèƒ½
            const token = localStorage.getItem('authToken');
            const response = await fetch(`/api/search/${encodeURIComponent(query)}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                return await response.json();
            } else {
                // å¦‚æœæœåŠ¡å™¨æœç´¢å¤±è´¥ï¼Œä½¿ç”¨å®¢æˆ·ç«¯æœç´¢ä½œä¸ºå¤‡é€‰
                return this.items.filter(item => 
                    item.name.toLowerCase().includes(query.toLowerCase())
                );
            }
        } catch (error) {
            // å¦‚æœæœåŠ¡å™¨æœç´¢å¤±è´¥ï¼Œä½¿ç”¨å®¢æˆ·ç«¯æœç´¢ä½œä¸ºå¤‡é€‰
            return this.items.filter(item => 
                item.name.toLowerCase().includes(query.toLowerCase())
            );
        }
    }

    getTotalItems() {
        return this.items.length;
    }

    getTotalQuantity() {
        return this.items.reduce((sum, item) => sum + item.quantity, 0);
    }

    // åŒæ­¥ç‰ˆæœ¬çš„æœç´¢æ–¹æ³•ï¼Œç”¨äºæ¸²æŸ“æ—¶
    // ä¿®å¤ï¼šå‰ç«¯ä¸æ‰§è¡Œæ‹¼éŸ³æœç´¢ï¼ŒåªåšåŸºç¡€æœç´¢ï¼Œæ‹¼éŸ³æœç´¢ç”±æœåŠ¡å™¨ç«¯å®Œæˆ
    searchItemsSync(query) {
        if (!query) return this.items;
        
        // åªåšåŸºç¡€çš„æ–‡æœ¬åŒ¹é…ï¼Œæ‹¼éŸ³æœç´¢ç”±æœåŠ¡å™¨ç«¯å®Œæˆ
        return this.items.filter(item => 
            item.name.toLowerCase().includes(query.toLowerCase())
        );
    }

    bindEvents() {
        const addItemBtn = document.getElementById('addItemBtn');
        const itemNameInput = document.getElementById('itemName');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const itemThresholdInput = document.getElementById('itemThreshold');
        const searchInput = document.getElementById('searchInput');
        const fileInput = document.getElementById('fileInput');
        const batchDeleteBtn = document.getElementById('batchDeleteBtn');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');

        // æ·»åŠ è´§ç‰©æŒ‰é’®
        addItemBtn.addEventListener('click', () => {
            const name = itemNameInput.value;
            const quantity = itemQuantityInput.value;
            const threshold = itemThresholdInput.value;

            if (this.addItem(name, quantity, threshold)) {
                itemNameInput.value = '';
                itemQuantityInput.value = '';
                itemThresholdInput.value = '5'; // é‡ç½®ä¸ºé»˜è®¤å€¼
                itemNameInput.focus();
            }
        });

        // å…¨é€‰å¤é€‰æ¡†
        selectAllCheckbox.addEventListener('change', () => {
            this.selectAllItems(selectAllCheckbox.checked);
        });

        // æ‰¹é‡åˆ é™¤æŒ‰é’®
        batchDeleteBtn.addEventListener('click', () => {
            this.deleteSelectedItems();
        });

        // è®¾ç½®é¡µé¢çš„å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const settingsFileInput = document.getElementById('fileInput');
        
        if (exportDataBtn) {
            exportDataBtn.addEventListener('click', () => {
                this.exportData();
            });
        }
        
        if (importDataBtn) {
            importDataBtn.addEventListener('click', () => {
                if (settingsFileInput) {
                    settingsFileInput.click();
                }
            });
        }
        
        if (settingsFileInput) {
            settingsFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    this.importData(e.target.files[0]);
                    e.target.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
                }
            });
        }

        // æŒ‰Enteré”®æ·»åŠ è´§ç‰©
        itemNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addItemBtn.click();
            }
        });

        itemQuantityInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addItemBtn.click();
            }
        });

        // æœç´¢åŠŸèƒ½ - å®ç°å®æ—¶æœç´¢
        searchInput.addEventListener('input', () => {
            this.render();
        });
        
        // æœç´¢æ¡†çš„å›è½¦äº‹ä»¶
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.render();
            }
        });

        // å¯¼å‡ºæ•°æ®æŒ‰é’®
        exportDataBtn.addEventListener('click', () => {
            this.exportData();
        });

        // å¯¼å…¥æ•°æ®æŒ‰é’®
        importDataBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                this.importData(e.target.files[0]);
                e.target.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
            }
        });

        // å…¨é€‰æŒ‰é’®
        selectAllBtn.addEventListener('click', () => {
            this.selectAllItems();
        });

        // æ‰¹é‡åˆ é™¤æŒ‰é’®
        batchDeleteBtn.addEventListener('click', () => {
            this.deleteSelectedItems();
        });

        // æ“ä½œæŒ‰é’®å±•å¼€/æ”¶å›åˆ‡æ¢
        toggleButtonsBtn.addEventListener('click', () => {
            actionButtonsContainer.classList.toggle('collapsed');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const isCollapsed = actionButtonsContainer.classList.contains('collapsed');
            const currentLang = localStorage.getItem('language') || 'zh-CN';
            if (currentLang === 'en-US') {
                toggleButtonsBtn.textContent = isCollapsed ? 'Actions' : 'Collapse';
            } else {
                toggleButtonsBtn.textContent = isCollapsed ? 'æ“ä½œ' : 'æ”¶èµ·';
            }
        });
        
        // æµ®åŠ¨æ“ä½œæŒ‰é’®åŠŸèƒ½ - æ·»åŠ å®‰å…¨æ£€æŸ¥
        if (fabToggle && fabMenu && fabExportBtn && fabImportBtn && fabSelectAllBtn && fabBatchDeleteBtn) {
            fabToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                fabMenu.classList.toggle('hidden');
            });
            
            // ä¸ºæµ®åŠ¨èœå•æŒ‰é’®æ·»åŠ äº‹ä»¶
            fabExportBtn.addEventListener('click', () => {
                this.exportData();
                fabMenu.classList.add('hidden');
            });
            
            fabImportBtn.addEventListener('click', () => {
                fileInput.click();
                fabMenu.classList.add('hidden');
            });
            
            fabSelectAllBtn.addEventListener('click', () => {
                this.selectAllItems();
                fabMenu.classList.add('hidden');
            });
            
            fabBatchDeleteBtn.addEventListener('click', () => {
                this.deleteSelectedItems();
                fabMenu.classList.add('hidden');
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            document.addEventListener('click', (e) => {
                if (fabToggle && fabMenu && !fabToggle.contains(e.target) && !fabMenu.contains(e.target)) {
                    fabMenu.classList.add('hidden');
                }
            });
        }
    }

    render() {
        this.renderStats();
        this.renderInventory();
        this.updateSelectAllCheckbox();
    }
    
    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çš„çŠ¶æ€
    updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (!selectAllCheckbox) return;
        
        const searchQuery = document.getElementById('searchInput').value;
        let displayedItems;
        if (!searchQuery) {
            displayedItems = this.items;
        } else {
            displayedItems = this.items.filter(item => 
                item.name.toLowerCase().includes(searchQuery.toLowerCase())
            );
        }
        
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ˜¾ç¤ºçš„é¡¹ç›®éƒ½è¢«é€‰ä¸­
        const allSelected = displayedItems.length > 0 && displayedItems.every(item => this.selectedItems.has(item.id));
        
        // å¦‚æœæ²¡æœ‰ä»»ä½•é¡¹ç›®ï¼Œä¹Ÿåº”è¯¥å–æ¶ˆé€‰ä¸­
        selectAllCheckbox.checked = displayedItems.length > 0 && allSelected;
    }

    renderStats() {
        document.getElementById('totalItems').textContent = this.getTotalItems();
        document.getElementById('totalQuantity').textContent = this.getTotalQuantity();
    }

    async renderInventory() {
        const inventoryList = document.getElementById('inventoryList');
        const searchQuery = document.getElementById('searchInput').value;
        const currentLang = localStorage.getItem('language') || 'zh-CN';
        
        // å¯¹äºç©ºæœç´¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®ï¼›å¦åˆ™æ‰§è¡Œæœç´¢
        let filteredItems;
        if (!searchQuery) {
            filteredItems = this.items;
        } else {
            // ä½¿ç”¨å¼‚æ­¥æœç´¢æ–¹æ³•
            filteredItems = await this.searchItems(searchQuery);
        }

        if (filteredItems.length === 0) {
            let emptyStateText, emptyStateSubText;
            if (currentLang === 'en-US') {
                emptyStateText = 'No inventory data';
                emptyStateSubText = searchQuery ? `No results found for "${searchQuery}"` : 'Add your first item!';
            } else {
                emptyStateText = 'æš‚æ— åº“å­˜æ•°æ®';
                emptyStateSubText = searchQuery ? `æœç´¢"${searchQuery}"æœªæ‰¾åˆ°ç»“æœ` : 'æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä»¶è´§ç‰©å§ï¼';
            }
            
            inventoryList.innerHTML = `
                <div class="empty-state">
                    <p>${emptyStateText}</p>
                    <p>${emptyStateSubText}</p>
                </div>
            `;
            return;
        }

        // åˆ›å»ºæ–°çš„HTMLå†…å®¹
        const newHTML = filteredItems.map(item => {
            const showChart = this.expandedChartId === item.id;
            const chartId = `chart-${item.id}`;
            
            // æ ¹æ®è¯­è¨€è®¾ç½®ç¡®å®šåˆ é™¤æŒ‰é’®æ–‡æœ¬
            const deleteButtonText = currentLang === 'en-US' ? 'Delete' : 'åˆ é™¤';
            // æ ¹æ®è¯­è¨€è®¾ç½®ç¡®å®šä½åº“å­˜æé†’æ–‡æœ¬
            const lowStockAlertText = currentLang === 'en-US' ? 'Low Stock Alert:' : 'ä½åº“å­˜æé†’:';
            
            return `
                <div class="inventory-item ${this.isLowStock(item) ? 'low-stock' : ''}" data-id="${item.id}">
                    <div class="item-selector">
                        <input type="checkbox" class="item-checkbox" data-id="${item.id}" ${this.selectedItems.has(item.id) ? 'checked' : ''}>
                    </div>
                    <div class="item-info" onclick="warehouseManager.toggleChart(${item.id})">
                        <div class="item-name">${item.name}</div>
                        <div class="item-id">ID: ${item.id} | ${lowStockAlertText} ${item.threshold || this.lowStockThreshold}</div>
                    </div>
                    <div class="item-controls">
                        <div class="quantity-display">${item.quantity}</div>
                        <button class="quantity-btn minus" onclick="warehouseManager.updateQuantity(${item.id}, ${Math.max(0, item.quantity - 1)})">-</button>
                        <button class="quantity-btn plus" onclick="warehouseManager.updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                        <button class="delete-btn" onclick="warehouseManager.deleteItem(${item.id})">${deleteButtonText}</button>
                    </div>
                </div>
                <div class="chart-container ${showChart ? 'expanded' : ''}" id="chart-area-${item.id}">
                    <div class="chart-wrapper">
                        <canvas id="${chartId}" class="inventory-chart"></canvas>
                    </div>
                </div>
            `;
        }).join('');

        // ä¿å­˜ä¹‹å‰çš„å…ƒç´ å¼•ç”¨ä»¥ä¾¿æ¯”è¾ƒ
        const previousItems = new Set();
        const existingElements = inventoryList.querySelectorAll('.inventory-item');
        existingElements.forEach(el => {
            previousItems.add(parseInt(el.dataset.id));
        });

        // æ›´æ–°å†…å®¹
        inventoryList.innerHTML = newHTML;

        // ä¸ºæ–°å¢çš„é¡¹ç›®æ·»åŠ è¿›å…¥åŠ¨ç”»
        const currentItems = new Set(filteredItems.map(item => item.id));
        const addedItems = [...currentItems].filter(id => !previousItems.has(id));

        addedItems.forEach(id => {
            const newItem = inventoryList.querySelector(`.inventory-item[data-id="${id}"]`);
            if (newItem) {
                // åˆå§‹çŠ¶æ€ï¼šé€æ˜ä¸”ç¨å¾®ç¼©å°
                newItem.style.opacity = '0';
                newItem.style.transform = 'translateX(-20px) scale(0.95)';
                newItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease';

                // å¼ºåˆ¶é‡ç»˜åè§¦å‘åŠ¨ç”»
                setTimeout(() => {
                    newItem.style.opacity = '1';
                    newItem.style.transform = 'translateX(0) scale(1)';
                }, 10);
            }
        });

        // ä¸ºå¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const itemId = parseInt(e.target.dataset.id);
                if (e.target.checked) {
                    this.selectedItems.add(itemId);
                } else {
                    this.selectedItems.delete(itemId);
                }
                
                // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
                this.updateSelectAllCheckbox();
            });
        });

        // ä¸ºå±•å¼€çš„å›¾è¡¨ç»˜åˆ¶å›¾å½¢
        setTimeout(() => {
            filteredItems.forEach(item => {
                if (this.expandedChartId === item.id) {
                    this.drawChart(`chart-${item.id}`, item.id);
                }
            });
        }, 100);
    }
}

// åˆå§‹åŒ–ä»“åº“ç®¡ç†ç³»ç»Ÿ
let warehouseManager;
document.addEventListener('DOMContentLoaded', () => {
    warehouseManager = new WarehouseManager();
});

// PWA å®‰è£…åŠŸèƒ½
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent the mini-infobar from appearing on mobile
    e.preventDefault();
    // Stash the event so it can be triggered later
    deferredPrompt = e;
    // Show install button if supported
    showInstallButton();
});

function showInstallButton() {
    // åˆ›å»ºå®‰è£…æŒ‰é’®
    const controlsDiv = document.querySelector('.controls');
    const installBtn = document.createElement('button');
    installBtn.textContent = 'å®‰è£…åº”ç”¨';
    installBtn.className = 'btn-primary';
    installBtn.style.marginTop = '15px';
    installBtn.style.width = '100%';
    
    installBtn.addEventListener('click', () => {
        // Hide the install button
        installBtn.style.display = 'none';
        // Show the install prompt
        deferredPrompt.prompt();
        // Wait for the user to respond to the prompt
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
            }
            deferredPrompt = null;
        });
    });
    
    controlsDiv.appendChild(installBtn);
}

// æ³¨å†Œ Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}